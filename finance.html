<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Finance | ML TRANSPORT</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

<!-- Phosphor Icons -->
<script src="https://unpkg.com/phosphor-icons"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- FileSaver for Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Toastr for notifications -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Style amélioré -->
<style>
:root {
  --card-border-radius: 12px;
  --card-padding: 1.25rem;
  --transition-speed: 0.3s;
}

/* Cartes de synthèse améliorées */
.summary-card {
  border-radius: var(--card-border-radius);
  padding: var(--card-padding);
  transition: all var(--transition-speed) ease;
  border: none;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  position: relative;
  overflow: hidden;
}

.summary-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
}

.summary-card-today {
  background: linear-gradient(135deg, #198754 0%, #2ecc71 100%);
  color: white;
}

.summary-card-today::before {
  background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
}

.summary-card-week {
  background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
  color: white;
}

.summary-card-week::before {
  background: linear-gradient(90deg, #2980b9 0%, #3498db 100%);
}

.summary-card-month {
  background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
  color: #2c3e50;
}

.summary-card-month::before {
  background: linear-gradient(90deg, #f39c12 0%, #f1c40f 100%);
}

.summary-card-total {
  background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
  color: white;
}

.summary-card-total::before {
  background: linear-gradient(90deg, #8e44ad 0%, #9b59b6 100%);
}

.summary-card-expenses {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: white;
}

.summary-card-expenses::before {
  background: linear-gradient(90deg, #c0392b 0%, #e74c3c 100%);
}

.summary-card-profit {
  background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
  color: white;
}

.summary-card-profit::before {
  background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
}

.summary-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.summary-card .card-title {
  font-size: 1rem;
  font-weight: 500;
  opacity: 0.9;
  margin-bottom: 0.5rem;
}

.summary-card .card-text {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
}

.summary-card small {
  display: block;
  font-size: 0.8rem;
  opacity: 0.8;
}

/* Cartes de recettes */
.receipt-card {
  transition: all var(--transition-speed) ease;
  border-left: 4px solid;
  border-radius: var(--card-border-radius);
}

.receipt-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.receipt-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.receipt-normal {
  border-left-color: #198754; /* Vert pour montant normal */
}

.receipt-low {
  border-left-color: #dc3545; /* Rouge pour montant faible */
  background-color: rgba(220, 53, 69, 0.05);
}

.receipt-high {
  border-left-color: #ffc107; /* Jaune pour montant élevé */
  background-color: rgba(255, 193, 7, 0.05);
}

.comment-icon {
  cursor: pointer;
  transition: all var(--transition-speed);
}

.comment-icon:hover {
  transform: scale(1.1);
  color: #0d6efd;
}

.comment-bubble {
  background-color: #f8f9fa;
  border-radius: 10px;
  padding: 10px;
  margin-top: 10px;
  border-left: 3px solid #0d6efd;
}

.target-indicator {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 5px;
}

.target-met {
  background-color: #198754;
  color: white;
}

.target-not-met {
  background-color: #dc3545;
  color: white;
}

/* Boutons d'action */
.action-btn {
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  margin-left: 5px;
  transition: all var(--transition-speed);
}

.action-btn:hover {
  transform: scale(1.1);
}

.edit-btn {
  background-color: rgba(13, 110, 253, 0.1);
  color: #0d6efd;
  border: none;
}

.edit-btn:hover {
  background-color: rgba(13, 110, 253, 0.2);
}

.delete-btn {
  background-color: rgba(220, 53, 69, 0.1);
  color: #dc3545;
  border: none;
}

.delete-btn:hover {
  background-color: rgba(220, 53, 69, 0.2);
}

/* Styles pour les dépenses */
.expense-item {
  border-left: 4px solid #e74c3c;
  transition: all var(--transition-speed) ease;
}

.expense-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.expense-details {
  font-size: 0.9em;
  color: #6c757d;
}

/* Styles pour les justificatifs */
.justificatif-container {
  margin-top: 10px;
}

.justificatif-image {
  max-width: 100%;
  max-height: 200px;
  border-radius: 5px;
  cursor: pointer;
  transition: transform 0.3s;
}

.justificatif-image:hover {
  transform: scale(1.05);
}

/* Onglets */
.nav-tabs .nav-link {
  border: none;
  color: #495057;
  font-weight: 500;
}

.nav-tabs .nav-link.active {
  color: #0d6efd;
  border-bottom: 3px solid #0d6efd;
  background-color: transparent;
}

.nav-tabs .nav-link:hover:not(.active) {
  border-bottom: 3px solid #dee2e6;
}

/* Autres styles */
.bus-select-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.bus-select-option .status-badge {
  font-size: 0.7rem;
  padding: 2px 6px;
}

.form-control:focus, .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.input-group-text {
  transition: all var(--transition-speed) ease;
}

.input-group:focus-within .input-group-text {
  background-color: #e7f1ff;
  color: #0d6efd;
}

@media print {
  .no-print {
    display: none !important;
  }

  .receipt-card, .expense-item {
    break-inside: avoid;
    box-shadow: none !important;
  }
}

/* Animation pour les nouvelles entrées */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.new-entry {
  animation: fadeIn 0.5s ease-out;
}

/* Styles pour le calendrier des coches */
.calendar {
  width: 100%;
  border-collapse: collapse;
}

.calendar th {
  text-align: center;
  padding: 10px;
  background-color: #f8f9fa;
  font-weight: 500;
}

.calendar td {
  padding: 10px;
  text-align: center;
  border: 1px solid #dee2e6;
  height: 40px;
  position: relative;
}

.calendar-day {
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 0.8em;
}

.day-badge {
  display: inline-block;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  line-height: 24px;
  font-size: 0.7em;
  font-weight: bold;
}

.badge-complete {
  background-color: #198754;
  color: white;
}

.badge-partial {
  background-color: #ffc107;
  color: #212529;
}

.badge-none {
  background-color: #dc3545;
  color: white;
}

.badge-future {
  background-color: #f8f9fa;
  color: #6c757d;
  border: 1px solid #dee2e6;
}

.month-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.month-title {
  font-weight: bold;
  font-size: 1.2em;
}

.month-nav {
  display: flex;
  gap: 10px;
}

.legend {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.9em;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 50%;
}

/* Modal pour les images */
.modal-image {
  max-width: 100%;
  max-height: 80vh;
}

/* Styles pour l'onglet Salaires */
.salary-card {
  border-left: 4px solid #6f42c1;
  transition: all var(--transition-speed) ease;
}

.salary-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.salary-summary {
  background: linear-gradient(135deg, #6f42c1 0%, #6610f2 100%);
  color: white;
}

.salary-summary::before {
  background: linear-gradient(90deg, #6610f2 0%, #6f42c1 100%);
}

.working-day {
  background-color: rgba(25, 135, 84, 0.1);
  border-left: 3px solid #198754;
}

.non-working-day {
  background-color: rgba(220, 53, 69, 0.1);
  border-left: 3px solid #dc3545;
}

.salary-details {
  font-size: 0.9em;
  color: #6c757d;
}

.driver-photo {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #dee2e6;
}

/* Toastr custom */
.toast {
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.toast-success {
  background-color: #198754 !important;
}

.toast-error {
  background-color: #dc3545 !important;
}

.toast-info {
  background-color: #0dcaf0 !important;
}

.toast-warning {
  background-color: #ffc107 !important;
  color: #212529 !important;
}
</style>
</head>
<body class="light-mode">
<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <i class="ph ph-bus fs-3 me-2 text-primary"></i>
      <span class="fw-bold">ML TRANSPORT</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="index.html"><i class="ph ph-gauge me-1"></i> Tableau de bord</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="finance.html"><i class="ph ph-wallet me-1"></i> Finance</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="bus.html"><i class="ph ph-bus me-1"></i> Gestion des bus</a>
        </li>
      </ul>
      <div class="d-flex align-items-center">
        <span class="me-3 text-muted small">
          <i class="ph ph-user-circle me-1"></i> Admin
        </span>
      </div>
    </div>
  </div>
</nav>

<!-- CONTENU PRINCIPAL -->
<main class="container mt-5 pt-5">

  <!-- ZONE DES TOTAUX - NOUVEAU DESIGN -->
  <div class="row text-center mb-4 g-3" id="zoneTotaux">
    <div class="col-md-3">
      <div class="summary-card summary-card-today">
        <div class="card-body p-2">
          <h5 class="card-title"><i class="ph ph-sun me-1"></i> Recettes Aujourd'hui</h5>
          <p class="card-text" id="totalJour">0 XAF</p>
          <small id="dailyTargetStatus"></small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="summary-card summary-card-expenses">
        <div class="card-body p-2">
          <h5 class="card-title"><i class="ph ph-arrow-down-left me-1"></i> Dépenses Aujourd'hui</h5>
          <p class="card-text" id="depensesJour">0 XAF</p>
          <small>Total des dépenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="summary-card summary-card-profit">
        <div class="card-body p-2">
          <h5 class="card-title"><i class="ph ph-trend-up me-1"></i> Bénéfice Aujourd'hui</h5>
          <p class="card-text" id="profitJour">0 XAF</p>
          <small>Recettes - Dépenses</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="summary-card summary-card-total">
        <div class="card-body p-2">
          <h5 class="card-title"><i class="ph ph-coin me-1"></i> Bénéfice Total</h5>
          <p class="card-text" id="totalProfit">0 XAF</p>
          <small>Toutes opérations</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Onglets -->
  <ul class="nav nav-tabs mb-4" id="financeTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="recettes-tab" data-bs-toggle="tab" data-bs-target="#recettes" type="button" role="tab">
        <i class="ph ph-wallet me-1"></i> Recettes
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="depenses-tab" data-bs-toggle="tab" data-bs-target="#depenses" type="button" role="tab">
        <i class="ph ph-arrow-down-left me-1"></i> Dépenses
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="coches-tab" data-bs-toggle="tab" data-bs-target="#coches" type="button" role="tab">
        <i class="ph ph-calendar-check me-1"></i> Coches
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="salaires-tab" data-bs-toggle="tab" data-bs-target="#salaires" type="button" role="tab">
        <i class="ph ph-money me-1"></i> Salaires
      </button>
    </li>
  </ul>

  <!-- Contenu des onglets -->
  <div class="tab-content" id="financeTabsContent">
    <!-- Onglet Recettes -->
    <div class="tab-pane fade show active" id="recettes" role="tabpanel">
      <h2 class="text-center my-4 text-success">
        <i class="ph ph-wallet fs-2"></i> Enregistrement des Recettes
      </h2>

      <form id="recetteForm" class="card p-4 shadow-sm mb-4">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="dateRecette" class="form-label">Date</label>
            <input type="date" class="form-control" id="dateRecette" required>
          </div>
          <div class="col-md-4 mb-3">
            <label for="matriculeBus" class="form-label">Matricule du bus</label>
            <select class="form-select" id="matriculeBus" required>
              <option value="">-- Sélectionnez un bus --</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="montantRecette" class="form-label">Montant versé (XAF)</label>
            <div class="input-group">
              <input type="number" class="form-control" id="montantRecette" min="0" step="100" required>
              <span class="input-group-text">XAF</span>
            </div>
            <div class="form-text text-muted">Objectif journalier: 35 000 XAF</div>
          </div>
        </div>
        <div class="mb-3">
          <label for="commentaireRecette" class="form-label">Commentaire (facultatif)</label>
          <textarea class="form-control" id="commentaireRecette" rows="2" placeholder="Ex: Paiement partiel, client XYZ..."></textarea>
        </div>
        <button type="submit" class="btn btn-success w-100">
          <i class="ph ph-check-circle"></i> Enregistrer
        </button>
      </form>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="ph ph-list-bullets"></i> Historique des recettes</h4>
        <div class="dropdown no-print">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="ph ph-export"></i> Exporter
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportToPDF('recettes')"><i class="ph ph-file-pdf"></i> PDF</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToExcel('recettes')"><i class="ph ph-file-xls"></i> Excel</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToCSV('recettes')"><i class="ph ph-file-csv"></i> CSV</a></li>
          </ul>
        </div>
      </div>

      <div class="mb-3">
        <div class="row">
          <div class="col-md-6">
            <input type="text" class="form-control" id="searchRecette" placeholder="Rechercher...">
          </div>
          <div class="col-md-6">
            <select class="form-select" id="filterBus">
              <option value="">Tous les bus</option>
            </select>
          </div>
        </div>
      </div>

      <div id="recetteList" class="mb-5"></div>
    </div>

    <!-- Onglet Dépenses -->
    <div class="tab-pane fade" id="depenses" role="tabpanel">
      <h2 class="text-center my-4 text-danger">
        <i class="ph ph-arrow-down-left fs-2"></i> Enregistrement des Dépenses
      </h2>

      <form id="depenseForm" class="card p-4 shadow-sm mb-4">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="dateDepense" class="form-label">Date</label>
            <input type="date" class="form-control" id="dateDepense" required>
          </div>
          <div class="col-md-4 mb-3">
            <label for="typeDepense" class="form-label">Type de dépense</label>
            <select class="form-select" id="typeDepense" required>
              <option value="">-- Sélectionnez --</option>
              <option value="bus">Liée à un bus</option>
              <option value="entreprise">Liée à l'entreprise</option>
            </select>
          </div>
          <div class="col-md-4 mb-3 d-none" id="busFieldDepense">
            <label for="busDepense" class="form-label">Bus concerné</label>
            <select class="form-select" id="busDepense">
              <option value="">-- Choisir un bus --</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="motifDepense" class="form-label">Motif</label>
            <input type="text" class="form-control" id="motifDepense" placeholder="Ex: Achat carburant, salaire, pièce..." required>
          </div>
          <div class="col-md-6 mb-3">
            <label for="montantDepense" class="form-label">Montant (XAF)</label>
            <div class="input-group">
              <input type="number" class="form-control" id="montantDepense" min="0" step="100" required>
              <span class="input-group-text">XAF</span>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label for="detailsDepense" class="form-label">Détails (Optionnel)</label>
          <textarea class="form-control" id="detailsDepense" rows="2" placeholder="Informations supplémentaires sur la dépense"></textarea>
        </div>
        <div class="mb-3">
          <label for="justificatifDepense" class="form-label">Justificatif (image, facultatif)</label>
          <input type="file" class="form-control" id="justificatifDepense" accept="image/*">
          <div class="form-text">Vous pouvez joindre une photo du reçu ou facture</div>
        </div>
        <button type="submit" class="btn btn-danger w-100">
          <i class="ph ph-check-circle"></i> Enregistrer
        </button>
      </form>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="ph ph-list-bullets"></i> Historique des dépenses</h4>
        <div class="dropdown no-print">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="ph ph-export"></i> Exporter
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportToPDF('depenses')"><i class="ph ph-file-pdf"></i> PDF</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToExcel('depenses')"><i class="ph ph-file-xls"></i> Excel</a></li>
            <li><a class="dropdown-item" href="#" onclick="exportToCSV('depenses')"><i class="ph ph-file-csv"></i> CSV</a></li>
          </ul>
        </div>
      </div>

      <div class="mb-3">
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn btn-outline-secondary" onclick="filtrerDepenses('all')">Toutes</button>
          <button type="button" class="btn btn-outline-secondary" onclick="filtrerDepenses('bus')">Bus</button>
          <button type="button" class="btn btn-outline-secondary" onclick="filtrerDepenses('entreprise')">Entreprise</button>
        </div>
      </div>

      <div id="depenseList" class="mb-5"></div>
    </div>

    <!-- Onglet Coches -->
    <div class="tab-pane fade" id="coches" role="tabpanel">
      <h2 class="text-center my-4 text-primary">
        <i class="ph ph-calendar-check fs-2"></i> Suivi des Recettes
      </h2>

      <div class="card p-4 shadow-sm mb-4">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="monthSelect" class="form-label">Sélectionnez un mois</label>
            <input type="month" class="form-control" id="monthSelect">
          </div>
          <div class="col-md-6 mb-3">
            <label for="busCalendarSelect" class="form-label">Sélectionnez un bus</label>
            <select class="form-select" id="busCalendarSelect">
              <option value="all">Tous les bus</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary w-100" type="button" onclick="generateCalendar()">
          <i class="ph ph-magnifying-glass"></i> Afficher le calendrier
        </button>
      </div>

      <div id="calendarContainer" class="mb-4">
        <!-- Le calendrier sera généré ici -->
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color bg-success"></div>
          <span>Recette complète</span>
        </div>
        <div class="legend-item">
          <div class="legend-color bg-warning"></div>
          <span>Recette partielle</span>
        </div>
        <div class="legend-item">
          <div class="legend-color bg-danger"></div>
          <span>Pas de recette</span>
        </div>
        <div class="legend-item">
          <div class="legend-color bg-light border"></div>
          <span>Jour futur</span>
        </div>
      </div>
    </div>

    <!-- Nouvel onglet Salaires -->
    <div class="tab-pane fade" id="salaires" role="tabpanel">
      <h2 class="text-center my-4 text-primary">
        <i class="ph ph-money fs-2"></i> Gestion des Salaires
      </h2>

      <div class="row">
        <div class="col-md-6">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h4><i class="ph ph-calculator"></i> Calcul du Salaire</h4>
              <p class="text-muted">Calcule automatiquement le salaire en fonction des jours travaillés (jours avec recettes)</p>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="driverSelect" class="form-label">Sélectionnez un chauffeur</label>
                  <select class="form-select" id="driverSelect" required>
                    <option value="">-- Choisir un chauffeur --</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="monthSalarySelect" class="form-label">Mois de calcul</label>
                  <input type="month" class="form-control" id="monthSalarySelect">
                </div>
              </div>
              
              <div class="alert alert-info" id="salaryCalculationInfo">
                <i class="ph ph-info"></i> Sélectionnez un chauffeur et un mois pour calculer le salaire
              </div>
              
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>Résumé du calcul</h5>
                <button class="btn btn-outline-primary" id="calculateSalaryBtn" disabled>
                  <i class="ph ph-calculator"></i> Calculer
                </button>
              </div>
              
              <div id="salaryCalculationResult" class="d-none">
                <div class="card salary-card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 id="driverNameDisplay">Nom du chauffeur</h5>
                        <small class="text-muted" id="salaryMonthDisplay">Mois</small>
                      </div>
                      <div class="text-end">
                        <h4 class="mb-0" id="calculatedSalary">0 XAF</h4>
                        <small class="text-muted">Salaire de base: 100 000 XAF</small>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card mb-3">
                  <div class="card-body">
                    <h6 class="card-title"><i class="ph ph-calendar"></i> Détails des jours travaillés</h6>
                    <div id="workingDaysDetails" class="mt-2">
                      <!-- Les jours travaillés seront affichés ici -->
                    </div>
                    <div class="mt-3">
                      <p class="mb-1"><strong>Total jours travaillés:</strong> <span id="totalWorkingDays">0</span> jours</p>
                      <p class="mb-1"><strong>Total jours non travaillés:</strong> <span id="totalNonWorkingDays">0</span> jours</p>
                      <p class="mb-0"><strong>Déduction totale:</strong> <span id="totalDeduction">0</span> XAF</p>
                    </div>
                  </div>
                </div>
                
                <button class="btn btn-primary w-100" id="paySalaryBtn">
                  <i class="ph ph-credit-card"></i> Enregistrer le paiement
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="ph ph-list-bullets"></i> Historique des paiements</h4>
                <div class="dropdown no-print">
                  <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="ph ph-export"></i> Exporter
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportSalariesToPDF()"><i class="ph ph-file-pdf"></i> PDF</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportSalariesToExcel()"><i class="ph ph-file-xls"></i> Excel</a></li>
                  </ul>
                </div>
              </div>
              
              <div class="mb-3">
                <input type="text" class="form-control" id="searchSalary" placeholder="Rechercher un chauffeur...">
              </div>
              
              <div id="salaryHistoryList">
                <!-- L'historique des paiements sera affiché ici -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL D'ÉDITION RECETTE -->
<div class="modal fade" id="editRecetteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Modifier la recette</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editRecetteForm">
          <input type="hidden" id="editRecetteId">
          <div class="mb-3">
            <label for="editRecetteDate" class="form-label">Date</label>
            <input type="date" class="form-control" id="editRecetteDate" required>
          </div>
          <div class="mb-3">
            <label for="editRecetteMatricule" class="form-label">Matricule du bus</label>
            <select class="form-select" id="editRecetteMatricule" required></select>
          </div>
          <div class="mb-3">
            <label for="editRecetteMontant" class="form-label">Montant (XAF)</label>
            <div class="input-group">
              <input type="number" class="form-control" id="editRecetteMontant" min="0" step="100" required>
              <span class="input-group-text">XAF</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="editRecetteCommentaire" class="form-label">Commentaire</label>
            <textarea class="form-control" id="editRecetteCommentaire" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveRecetteEdit">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL D'ÉDITION DEPENSE -->
<div class="modal fade" id="editDepenseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Modifier la dépense</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDepenseForm">
          <input type="hidden" id="editDepenseId">
          <div class="mb-3">
            <label for="editDepenseDate" class="form-label">Date</label>
            <input type="date" class="form-control" id="editDepenseDate" required>
          </div>
          <div class="mb-3">
            <label for="editDepenseType" class="form-label">Type de dépense</label>
            <select class="form-select" id="editDepenseType" required>
              <option value="bus">Liée à un bus</option>
              <option value="entreprise">Liée à l'entreprise</option>
            </select>
          </div>
          <div class="mb-3" id="editBusFieldDepense">
            <label for="editBusDepense" class="form-label">Bus concerné</label>
            <select class="form-select" id="editBusDepense">
              <option value="">-- Choisir un bus --</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editDepenseMotif" class="form-label">Motif</label>
            <input type="text" class="form-control" id="editDepenseMotif" required>
          </div>
          <div class="mb-3">
            <label for="editDepenseMontant" class="form-label">Montant (XAF)</label>
            <div class="input-group">
              <input type="number" class="form-control" id="editDepenseMontant" min="0" step="100" required>
              <span class="input-group-text">XAF</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="editDepenseDetails" class="form-label">Détails</label>
            <textarea class="form-control" id="editDepenseDetails" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="editDepenseJustificatif" class="form-label">Justificatif</label>
            <input type="file" class="form-control" id="editDepenseJustificatif" accept="image/*">
            <div class="form-text">Modifier le justificatif si nécessaire</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="saveDepenseEdit">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL POUR AFFICHER L'IMAGE -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Justificatif</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="modal-image" alt="Justificatif">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- BOUTON MODE SOMBRE/CLAIR -->
<button id="toggleTheme" class="btn btn-dark rounded-circle shadow theme-toggle no-print" title="Changer de thème">
  <i class="ph ph-moon-stars fs-4"></i>
</button>

<!-- FOOTER -->
<footer class="text-center py-3 bg-dark text-white">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <span>Powered by Forever/&gt;Inc</span>
      <span class="small">Dernière mise à jour: <span id="lastUpdate"></span></span>
    </div>
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Constantes
const DAILY_TARGET = 35000;
const HOLIDAY_TARGET = 30000;
const DEADLINE_HOUR = 22; // 22h pour la deadline
const DEADLINE_MINUTE = 55; // 55 minutes
const BASE_SALARY = 100000; // Salaire de base des chauffeurs

// Configuration des notifications
toastr.options = {
  closeButton: true,
  progressBar: true,
  positionClass: "toast-top-right",
  timeOut: 5000,
  extendedTimeOut: 2000,
  showEasing: "swing",
  hideEasing: "linear",
  showMethod: "fadeIn",
  hideMethod: "fadeOut"
};

// Éléments DOM
const recetteForm = document.getElementById('recetteForm');
const depenseForm = document.getElementById('depenseForm');
const recetteList = document.getElementById('recetteList');
const depenseList = document.getElementById('depenseList');
const searchRecette = document.getElementById('searchRecette');
const filterBus = document.getElementById('filterBus');
const typeDepense = document.getElementById('typeDepense');
const busFieldDepense = document.getElementById('busFieldDepense');
const busDepenseSelect = document.getElementById('busDepense');
const monthSelect = document.getElementById('monthSelect');
const busCalendarSelect = document.getElementById('busCalendarSelect');
const calendarContainer = document.getElementById('calendarContainer');

// Nouveaux éléments pour l'onglet Salaires
const driverSelect = document.getElementById('driverSelect');
const monthSalarySelect = document.getElementById('monthSalarySelect');
const calculateSalaryBtn = document.getElementById('calculateSalaryBtn');
const salaryCalculationResult = document.getElementById('salaryCalculationResult');
const salaryHistoryList = document.getElementById('salaryHistoryList');
const paySalaryBtn = document.getElementById('paySalaryBtn');
const searchSalary = document.getElementById('searchSalary');

// Modals
const editRecetteModal = new bootstrap.Modal(document.getElementById('editRecetteModal'));
const editDepenseModal = new bootstrap.Modal(document.getElementById('editDepenseModal'));
const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));

// Données
let recettes = JSON.parse(localStorage.getItem('recettes')) || [];
let depenses = JSON.parse(localStorage.getItem('depenses')) || [];
let salaries = JSON.parse(localStorage.getItem('salaries')) || [];
let currentEditIndex = -1;
let currentFilter = 'all';

// Récupérer les bus et chauffeurs depuis le localStorage ou une API
function getAvailableBuses() {
  try {
    // Essayer de récupérer depuis le localStorage
    const busesFromStorage = JSON.parse(localStorage.getItem('busList')) || [];

    if (busesFromStorage.length > 0) {
      return busesFromStorage.map(bus => ({
        matricule: bus.matricule,
        nom: bus.nom,
        service: bus.service,
        driver: bus.driver || null
      }));
    }

    // Si aucun bus dans le localStorage, utiliser des valeurs par défaut
    return [
      { matricule: 'AK678AA', nom: 'Bus Principal', service: 'Oui', driver: 'Jean Dupont' },
      { matricule: 'AK679BB', nom: 'Bus Secondaire', service: 'Oui', driver: 'Marie Martin' },
      { matricule: 'AK680CC', nom: 'Bus de Réserve', service: 'Non', driver: null }
    ];
  } catch (e) {
    console.error("Erreur lors de la récupération des bus:", e);
    return [];
  }
}

function getAvailableDrivers() {
  const buses = getAvailableBuses();
  const drivers = new Set();
  
  buses.forEach(bus => {
    if (bus.driver && bus.service === 'Oui') {
      drivers.add(bus.driver);
    }
  });
  
  return Array.from(drivers);
}

// Fonctions pour remplir les sélecteurs de bus
function populateBusSelect() {
  const select = document.getElementById('matriculeBus');
  select.innerHTML = '<option value="">-- Sélectionnez un bus --</option>';
  
  const buses = getAvailableBuses().filter(bus => bus.service === 'Oui');
  
  if (buses.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Aucun bus disponible';
    option.disabled = true;
    select.appendChild(option);
    return;
  }
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom} (${bus.driver || 'Pas de chauffeur'})`;
    select.appendChild(option);
  });
}

function populateBusFilter() {
  const select = document.getElementById('filterBus');
  select.innerHTML = '<option value="">Tous les bus</option>';
  
  const buses = getAvailableBuses().filter(bus => bus.service === 'Oui');
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom}`;
    select.appendChild(option);
  });
}

function populateDepenseBusSelect() {
  const select = document.getElementById('busDepense');
  select.innerHTML = '<option value="">-- Choisir un bus --</option>';
  
  const buses = getAvailableBuses();
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom}`;
    select.appendChild(option);
  });
}

function populateEditBusSelect() {
  const select = document.getElementById('editRecetteMatricule');
  select.innerHTML = '<option value="">-- Sélectionnez un bus --</option>';
  
  const buses = getAvailableBuses().filter(bus => bus.service === 'Oui');
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom}`;
    select.appendChild(option);
  });
}

function populateEditDepenseBusSelect() {
  const select = document.getElementById('editBusDepense');
  select.innerHTML = '<option value="">-- Choisir un bus --</option>';
  
  const buses = getAvailableBuses();
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom}`;
    select.appendChild(option);
  });
}

function populateCalendarBusSelect() {
  const select = document.getElementById('busCalendarSelect');
  select.innerHTML = '<option value="all">Tous les bus</option>';
  
  const buses = getAvailableBuses().filter(bus => bus.service === 'Oui');
  
  buses.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.matricule;
    option.textContent = `${bus.matricule} - ${bus.nom}`;
    select.appendChild(option);
  });
}

function populateDriverSelect() {
  const select = document.getElementById('driverSelect');
  select.innerHTML = '<option value="">-- Choisir un chauffeur --</option>';
  
  const drivers = getAvailableDrivers();
  
  if (drivers.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'Aucun chauffeur disponible';
    option.disabled = true;
    select.appendChild(option);
    return;
  }
  
  drivers.forEach(driver => {
    const option = document.createElement('option');
    option.value = driver;
    option.textContent = driver;
    select.appendChild(option);
  });
}

// Formatage des dates
function formatDate(dateString) {
  const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
  return new Date(dateString).toLocaleDateString('fr-FR', options);
}

// Affichage des notifications
function showNotification(message, type = 'success') {
  toastr[type](message);
}

// Gestion des formulaires
function handleRecetteSubmit(e) {
  e.preventDefault();
  
  const date = document.getElementById('dateRecette').value;
  const matricule = document.getElementById('matriculeBus').value;
  const montant = parseFloat(document.getElementById('montantRecette').value);
  const commentaire = document.getElementById('commentaireRecette').value;
  
  if (!date || !matricule || isNaN(montant)) {
    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
    return;
  }
  
  const newRecette = {
    id: Date.now(),
    date,
    matricule,
    montant,
    commentaire,
    createdAt: new Date().toISOString()
  };
  
  recettes.push(newRecette);
  localStorage.setItem('recettes', JSON.stringify(recettes));
  
  showNotification('Recette enregistrée avec succès', 'success');
  afficherRecettes();
  mettreAJourTotaux();
  recetteForm.reset();
  document.getElementById('dateRecette').valueAsDate = new Date();
}

function handleDepenseSubmit(e) {
  e.preventDefault();
  
  const date = document.getElementById('dateDepense').value;
  const type = document.getElementById('typeDepense').value;
  const bus = type === 'bus' ? document.getElementById('busDepense').value : null;
  const motif = document.getElementById('motifDepense').value;
  const montant = parseFloat(document.getElementById('montantDepense').value);
  const details = document.getElementById('detailsDepense').value;
  const justificatif = document.getElementById('justificatifDepense').files[0];
  
  if (!date || !type || !motif || isNaN(montant)) {
    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
    return;
  }
  
  if (type === 'bus' && !bus) {
    showNotification('Veuillez sélectionner un bus', 'error');
    return;
  }
  
  const newDepense = {
    id: Date.now(),
    date,
    type,
    bus,
    motif,
    montant,
    details,
    justificatif: justificatif ? justificatif.name : null,
    isSalary: false,
    createdAt: new Date().toISOString()
  };
  
  depenses.push(newDepense);
  localStorage.setItem('depenses', JSON.stringify(depenses));
  
  showNotification('Dépense enregistrée avec succès', 'success');
  afficherDepenses();
  mettreAJourTotaux();
  depenseForm.reset();
  document.getElementById('dateDepense').valueAsDate = new Date();
  busFieldDepense.classList.add('d-none');
}

// Affichage des recettes
function afficherRecettes(filter = '') {
  recetteList.innerHTML = '';
  
  if (recettes.length === 0) {
    recetteList.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="ph ph-info"></i> Aucune recette enregistrée
      </div>
    `;
    return;
  }
  
  const searchTerm = filter.toLowerCase();
  const busFilter = document.getElementById('filterBus').value;
  
  let filteredRecettes = recettes
    .filter(r => 
      r.matricule.toLowerCase().includes(searchTerm) || 
      r.commentaire?.toLowerCase().includes(searchTerm) ||
      r.montant.toString().includes(searchTerm)
    );
  
  if (busFilter) {
    filteredRecettes = filteredRecettes.filter(r => r.matricule === busFilter);
  }
  
  filteredRecettes.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (filteredRecettes.length === 0) {
    recetteList.innerHTML = `
      <div class="alert alert-warning text-center">
        <i class="ph ph-warning"></i> Aucune recette trouvée
      </div>
    `;
    return;
  }
  
  const fragment = document.createDocumentFragment();
  
  filteredRecettes.forEach((recette, index) => {
    const bus = getAvailableBuses().find(b => b.matricule === recette.matricule);
    const busName = bus ? bus.nom : 'Inconnu';
    const driverName = bus?.driver || 'Non attribué';
    
    const card = document.createElement('div');
    card.className = `card mb-3 p-3 receipt-card ${recette.montant >= DAILY_TARGET ? 'receipt-normal' : recette.montant >= DAILY_TARGET * 0.5 ? 'receipt-high' : 'receipt-low'}`;
    
    card.innerHTML = `
      <div class="receipt-card-header">
        <div>
          <h5 class="mb-1">
            <i class="ph ph-bus"></i> ${recette.matricule} - ${busName}
          </h5>
          <small class="text-muted">${formatDate(recette.date)}</small>
        </div>
        <div class="text-end">
          <h4 class="mb-0">${recette.montant.toLocaleString()} XAF</h4>
          <small>${driverName}</small>
        </div>
      </div>
      ${recette.commentaire ? `
        <div class="comment-bubble mt-2">
          <p class="mb-0">${recette.commentaire}</p>
        </div>
      ` : ''}
      <div class="d-flex justify-content-end mt-3">
        <button class="action-btn edit-btn no-print" onclick="editerRecette(${index})" title="Modifier">
          <i class="ph ph-pencil-simple"></i>
        </button>
        <button class="action-btn delete-btn no-print" onclick="supprimerRecette(${index})" title="Supprimer">
          <i class="ph ph-trash"></i>
        </button>
      </div>
    `;
    
    fragment.appendChild(card);
  });
  
  recetteList.appendChild(fragment);
}

// Affichage des dépenses
function afficherDepenses(filter = '') {
  depenseList.innerHTML = '';
  
  if (depenses.length === 0) {
    depenseList.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="ph ph-info"></i> Aucune dépense enregistrée
      </div>
    `;
    return;
  }
  
  let filteredDepenses = [...depenses];
  
  if (currentFilter !== 'all') {
    filteredDepenses = filteredDepenses.filter(d => d.type === currentFilter);
  }
  
  filteredDepenses.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (filteredDepenses.length === 0) {
    depenseList.innerHTML = `
      <div class="alert alert-warning text-center">
        <i class="ph ph-warning"></i> Aucune dépense trouvée
      </div>
    `;
    return;
  }
  
  const fragment = document.createDocumentFragment();
  
  filteredDepenses.forEach((depense, index) => {
    const bus = depense.bus ? getAvailableBuses().find(b => b.matricule === depense.bus) : null;
    const busName = bus ? `${bus.matricule} - ${bus.nom}` : 'N/A';
    
    const card = document.createElement('div');
    card.className = 'card mb-3 p-3 expense-item';
    
    card.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">
            <i class="ph ph-arrow-down-left"></i> ${depense.motif}
          </h5>
          <small class="text-muted">${formatDate(depense.date)}</small>
          <div class="expense-details mt-2">
            <p class="mb-1"><strong>Type:</strong> ${depense.type === 'bus' ? 'Bus (' + busName + ')' : 'Entreprise'}</p>
            ${depense.details ? `<p class="mb-0">${depense.details}</p>` : ''}
          </div>
        </div>
        <div class="text-end">
          <h4 class="mb-0">${depense.montant.toLocaleString()} XAF</h4>
          <small>${depense.type === 'bus' ? 'Bus' : 'Entreprise'}</small>
        </div>
      </div>
      ${depense.justificatif ? `
        <div class="justificatif-container">
          <p class="mb-1"><strong>Justificatif:</strong></p>
          <button class="btn btn-sm btn-outline-primary" onclick="afficherJustificatif('${depense.justificatif}')">
            <i class="ph ph-file-image"></i> Voir le justificatif
          </button>
        </div>
      ` : ''}
      <div class="d-flex justify-content-end mt-3">
        <button class="action-btn edit-btn no-print" onclick="editerDepense(${index})" title="Modifier">
          <i class="ph ph-pencil-simple"></i>
        </button>
        <button class="action-btn delete-btn no-print" onclick="supprimerDepense(${index})" title="Supprimer">
          <i class="ph ph-trash"></i>
        </button>
      </div>
    `;
    
    fragment.appendChild(card);
  });
  
  depenseList.appendChild(fragment);
}

// Gestion des salaires
function updateCalculateButtonState() {
  calculateSalaryBtn.disabled = !(driverSelect.value && monthSalarySelect.value);
}

function calculateSalary() {
  const driver = driverSelect.value;
  const monthYear = monthSalarySelect.value;
  
  if (!driver || !monthYear) return;
  
  const [year, month] = monthYear.split('-').map(Number);
  const firstDay = new Date(year, month - 1, 1);
  const lastDay = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();
  
  // Trouver les bus associés à ce chauffeur
  const busesForDriver = getAvailableBuses().filter(bus => bus.driver === driver && bus.service === 'Oui');
  
  if (busesForDriver.length === 0) {
    showNotification('Aucun bus en service trouvé pour ce chauffeur', 'warning');
    return;
  }
  
  // Récupérer les matricules des bus associés
  const busMatricules = busesForDriver.map(bus => bus.matricule);
  
  // Trouver tous les jours avec recettes pour ces bus
  const workingDays = new Set();
  const monthStr = monthYear + '-';
  
  recettes.forEach(recette => {
    if (recette.date.startsWith(monthStr)) {
      if (busMatricules.includes(recette.matricule)) {
        const day = recette.date.split('-')[2];
        workingDays.add(day);
      }
    }
  });
  
  const totalWorkingDays = workingDays.size;
  const totalNonWorkingDays = daysInMonth - totalWorkingDays;
  const deductionPerDay = Math.floor(BASE_SALARY / daysInMonth);
  const totalDeduction = totalNonWorkingDays * deductionPerDay;
  const finalSalary = BASE_SALARY - totalDeduction;
  
  // Afficher les résultats
  document.getElementById('driverNameDisplay').textContent = driver;
  document.getElementById('salaryMonthDisplay').textContent = firstDay.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  document.getElementById('calculatedSalary').textContent = finalSalary.toLocaleString() + ' XAF';
  document.getElementById('totalWorkingDays').textContent = totalWorkingDays;
  document.getElementById('totalNonWorkingDays').textContent = totalNonWorkingDays;
  document.getElementById('totalDeduction').textContent = totalDeduction.toLocaleString();
  
  // Afficher les détails des jours travaillés
  const workingDaysDetails = document.getElementById('workingDaysDetails');
  workingDaysDetails.innerHTML = '';
  
  if (totalWorkingDays === 0) {
    workingDaysDetails.innerHTML = '<p class="text-muted">Aucun jour travaillé ce mois-ci</p>';
  } else {
    const sortedDays = Array.from(workingDays).sort((a, b) => a - b);
    const fragment = document.createDocumentFragment();
    
    sortedDays.forEach(day => {
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const date = new Date(dateStr);
      const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
      
      const dayElement = document.createElement('div');
      dayElement.className = 'd-flex justify-content-between align-items-center p-2 working-day mb-2 rounded';
      dayElement.innerHTML = `
        <div>
          <i class="ph ph-check-circle text-success"></i>
          <span class="ms-2">${formattedDate}</span>
        </div>
        <small class="text-muted">Jour travaillé</small>
      `;
      
      fragment.appendChild(dayElement);
    });
    
    workingDaysDetails.appendChild(fragment);
  }
  
  // Afficher la section des résultats
  salaryCalculationResult.classList.remove('d-none');
}

function paySalary() {
  const driver = driverSelect.value;
  const monthYear = monthSalarySelect.value;
  const finalSalary = parseInt(document.getElementById('calculatedSalary').textContent.replace(/\D/g, ''), 10);
  
  if (!driver || !monthYear || isNaN(finalSalary)) {
    showNotification('Veuillez d\'abord calculer le salaire', 'warning');
    return;
  }
  
  const today = new Date().toISOString().split('T')[0];
  const motif = `Salaire ${driver} - ${monthYear}`;
  
  const newDepense = {
    id: Date.now(),
    date: today,
    type: 'entreprise',
    bus: null,
    motif: motif,
    montant: finalSalary,
    details: `Paiement du salaire pour ${driver} pour le mois ${monthYear}`,
    justificatif: null,
    isSalary: true,
    driver: driver,
    month: monthYear,
    createdAt: new Date().toISOString()
  };
  
  depenses.push(newDepense);
  localStorage.setItem('depenses', JSON.stringify(depenses));
  
  // Ajouter à l'historique des salaires
  const salaryRecord = {
    id: Date.now(),
    date: today,
    driver: driver,
    month: monthYear,
    amount: finalSalary,
    workingDays: parseInt(document.getElementById('totalWorkingDays').textContent, 10),
    nonWorkingDays: parseInt(document.getElementById('totalNonWorkingDays').textContent, 10),
    deduction: parseInt(document.getElementById('totalDeduction').textContent.replace(/\D/g, ''), 10),
    createdAt: new Date().toISOString()
  };
  
  salaries.push(salaryRecord);
  localStorage.setItem('salaries', JSON.stringify(salaries));
  
  showNotification('Paiement du salaire enregistré avec succès', 'success');
  afficherDepenses();
  afficherHistoriqueSalaires();
  mettreAJourTotaux();
  
  // Réinitialiser le formulaire
  salaryCalculationResult.classList.add('d-none');
  driverSelect.value = '';
  monthSalarySelect.value = monthYear; // Garder le même mois sélectionné
  calculateSalaryBtn.disabled = true;
}

function afficherHistoriqueSalaires(filter = '') {
  salaryHistoryList.innerHTML = '';
  
  if (salaries.length === 0) {
    salaryHistoryList.innerHTML = `
      <div class="alert alert-info text-center">
        <i class="ph ph-info"></i> Aucun paiement de salaire enregistré
      </div>
    `;
    return;
  }
  
  const searchTerm = filter.toLowerCase();
  const filteredSalaries = salaries
    .filter(s => s.driver.toLowerCase().includes(searchTerm))
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (filteredSalaries.length === 0) {
    salaryHistoryList.innerHTML = `
      <div class="alert alert-warning text-center">
        <i class="ph ph-warning"></i> Aucun résultat trouvé
      </div>
    `;
    return;
  }
  
  const fragment = document.createDocumentFragment();
  
  filteredSalaries.forEach((salary, index) => {
    const card = document.createElement('div');
    card.className = 'card mb-3 p-3 salary-card';
    
    const [year, month] = salary.month.split('-');
    const monthName = new Date(year, month - 1, 1).toLocaleDateString('fr-FR', { month: 'long' });
    
    card.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">
            <i class="ph ph-user-circle"></i> ${salary.driver}
          </h5>
          <small class="text-muted">${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}</small>
          <div class="salary-details mt-2">
            <p class="mb-1"><i class="ph ph-calendar-check"></i> ${salary.workingDays} jours travaillés / ${salary.workingDays + salary.nonWorkingDays} jours</p>
            <p class="mb-0"><i class="ph ph-currency-circle-dollar"></i> Déduction: ${salary.deduction.toLocaleString()} XAF</p>
          </div>
        </div>
        <div class="text-end">
          <h4 class="mb-0">${salary.amount.toLocaleString()} XAF</h4>
          <small class="text-muted">${formatDate(salary.date)}</small>
        </div>
      </div>
      <div class="d-flex justify-content-end mt-2">
        <button class="action-btn delete-btn no-print" onclick="supprimerSalaire(${index})" title="Supprimer">
          <i class="ph ph-trash"></i>
        </button>
      </div>
    `;
    
    fragment.appendChild(card);
  });
  
  salaryHistoryList.appendChild(fragment);
}

function supprimerSalaire(index) {
  if (confirm("Voulez-vous vraiment supprimer cet enregistrement de salaire ? Cette action supprimera également la dépense correspondante.")) {
    const salary = salaries[index];
    
    // Supprimer la dépense correspondante
    const depenseIndex = depenses.findIndex(d => d.isSalary && d.month === salary.month && d.driver === salary.driver);
    if (depenseIndex !== -1) {
      depenses.splice(depenseIndex, 1);
      localStorage.setItem('depenses', JSON.stringify(depenses));
    }
    
    salaries.splice(index, 1);
    localStorage.setItem('salaries', JSON.stringify(salaries));
    afficherHistoriqueSalaires(searchSalary.value);
    afficherDepenses();
    mettreAJourTotaux();
    showNotification('Enregistrement de salaire supprimé', 'danger');
  }
}

// Gestion des modifications
function editerRecette(index) {
  const recette = recettes[index];
  currentEditIndex = index;
  
  document.getElementById('editRecetteId').value = recette.id;
  document.getElementById('editRecetteDate').value = recette.date;
  document.getElementById('editRecetteMontant').value = recette.montant;
  document.getElementById('editRecetteCommentaire').value = recette.commentaire || '';
  
  // Sélectionner le bon bus dans le select
  const select = document.getElementById('editRecetteMatricule');
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value === recette.matricule) {
      select.selectedIndex = i;
      break;
    }
  }
  
  editRecetteModal.show();
}

function saveEditedRecette() {
  const id = parseInt(document.getElementById('editRecetteId').value);
  const date = document.getElementById('editRecetteDate').value;
  const matricule = document.getElementById('editRecetteMatricule').value;
  const montant = parseFloat(document.getElementById('editRecetteMontant').value);
  const commentaire = document.getElementById('editRecetteCommentaire').value;
  
  if (!date || !matricule || isNaN(montant)) {
    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
    return;
  }
  
  const recetteIndex = recettes.findIndex(r => r.id === id);
  if (recetteIndex === -1) {
    showNotification('Recette introuvable', 'error');
    return;
  }
  
  recettes[recetteIndex] = {
    ...recettes[recetteIndex],
    date,
    matricule,
    montant,
    commentaire
  };
  
  localStorage.setItem('recettes', JSON.stringify(recettes));
  editRecetteModal.hide();
  afficherRecettes();
  mettreAJourTotaux();
  showNotification('Recette modifiée avec succès', 'success');
}

function editerDepense(index) {
  const depense = depenses[index];
  currentEditIndex = index;
  
  document.getElementById('editDepenseId').value = depense.id;
  document.getElementById('editDepenseDate').value = depense.date;
  document.getElementById('editDepenseType').value = depense.type;
  document.getElementById('editDepenseMotif').value = depense.motif;
  document.getElementById('editDepenseMontant').value = depense.montant;
  document.getElementById('editDepenseDetails').value = depense.details || '';
  
  // Gérer le champ bus
  const busField = document.getElementById('editBusFieldDepense');
  if (depense.type === 'bus') {
    busField.classList.remove('d-none');
    const select = document.getElementById('editBusDepense');
    for (let i = 0; i < select.options.length; i++) {
      if (select.options[i].value === depense.bus) {
        select.selectedIndex = i;
        break;
      }
    }
  } else {
    busField.classList.add('d-none');
  }
  
  editDepenseModal.show();
}

function saveEditedDepense() {
  const id = parseInt(document.getElementById('editDepenseId').value);
  const date = document.getElementById('editDepenseDate').value;
  const type = document.getElementById('editDepenseType').value;
  const bus = type === 'bus' ? document.getElementById('editBusDepense').value : null;
  const motif = document.getElementById('editDepenseMotif').value;
  const montant = parseFloat(document.getElementById('editDepenseMontant').value);
  const details = document.getElementById('editDepenseDetails').value;
  const justificatif = document.getElementById('editDepenseJustificatif').files[0];
  
  if (!date || !type || !motif || isNaN(montant)) {
    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
    return;
  }
  
  if (type === 'bus' && !bus) {
    showNotification('Veuillez sélectionner un bus', 'error');
    return;
  }
  
  const depenseIndex = depenses.findIndex(d => d.id === id);
  if (depenseIndex === -1) {
    showNotification('Dépense introuvable', 'error');
    return;
  }
  
  depenses[depenseIndex] = {
    ...depenses[depenseIndex],
    date,
    type,
    bus,
    motif,
    montant,
    details,
    justificatif: justificatif ? justificatif.name : depenses[depenseIndex].justificatif
  };
  
  localStorage.setItem('depenses', JSON.stringify(depenses));
  editDepenseModal.hide();
  afficherDepenses();
  mettreAJourTotaux();
  showNotification('Dépense modifiée avec succès', 'success');
}

// Suppression des éléments
function supprimerRecette(index) {
  if (confirm("Voulez-vous vraiment supprimer cette recette ?")) {
    recettes.splice(index, 1);
    localStorage.setItem('recettes', JSON.stringify(recettes));
    afficherRecettes();
    mettreAJourTotaux();
    showNotification('Recette supprimée', 'danger');
  }
}

function supprimerDepense(index) {
  if (confirm("Voulez-vous vraiment supprimer cette dépense ?")) {
    depenses.splice(index, 1);
    localStorage.setItem('depenses', JSON.stringify(depenses));
    afficherDepenses();
    mettreAJourTotaux();
    showNotification('Dépense supprimée', 'danger');
  }
}

// Mise à jour des totaux
function mettreAJourTotaux() {
  // Date d'aujourd'hui au format YYYY-MM-DD
  const today = new Date().toISOString().split('T')[0];
  
  // Calcul des recettes du jour
  const recettesAujourdhui = recettes
    .filter(r => r.date === today)
    .reduce((sum, r) => sum + r.montant, 0);
  
  // Calcul des dépenses du jour
  const depensesAujourdhui = depenses
    .filter(d => d.date === today)
    .reduce((sum, d) => sum + d.montant, 0);
  
  // Calcul du bénéfice du jour
  const profitAujourdhui = recettesAujourdhui - depensesAujourdhui;
  
  // Calcul du bénéfice total
  const totalRecettes = recettes.reduce((sum, r) => sum + r.montant, 0);
  const totalDepenses = depenses.reduce((sum, d) => sum + d.montant, 0);
  const totalProfit = totalRecettes - totalDepenses;
  
  // Mise à jour de l'interface
  document.getElementById('totalJour').textContent = recettesAujourdhui.toLocaleString() + ' XAF';
  document.getElementById('depensesJour').textContent = depensesAujourdhui.toLocaleString() + ' XAF';
  document.getElementById('profitJour').textContent = profitAujourdhui.toLocaleString() + ' XAF';
  document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + ' XAF';
  
  // Mise à jour du statut de l'objectif journalier
  const targetStatus = document.getElementById('dailyTargetStatus');
  if (recettesAujourdhui >= DAILY_TARGET) {
    targetStatus.innerHTML = '<i class="ph ph-check-circle"></i> Objectif atteint';
    targetStatus.className = 'text-success';
  } else if (recettesAujourdhui > 0) {
    const percentage = Math.round((recettesAujourdhui / DAILY_TARGET) * 100);
    targetStatus.innerHTML = `<i class="ph ph-warning"></i> ${percentage}% de l'objectif`;
    targetStatus.className = 'text-warning';
  } else {
    targetStatus.innerHTML = '<i class="ph ph-x-circle"></i> Objectif non atteint';
    targetStatus.className = 'text-danger';
  }
}

// Gestion du calendrier
function generateCalendar() {
  const monthYear = document.getElementById('monthSelect').value;
  const busMatricule = document.getElementById('busCalendarSelect').value;
  
  if (!monthYear) {
    showNotification('Veuillez sélectionner un mois', 'warning');
    return;
  }
  
  const [year, month] = monthYear.split('-').map(Number);
  const firstDay = new Date(year, month - 1, 1);
  const lastDay = new Date(year, month, 0);
  const daysInMonth = lastDay.getDate();
  const firstDayOfWeek = firstDay.getDay(); // 0 (dimanche) à 6 (samedi)
  
  // Filtrer les recettes pour le mois et bus sélectionné
  const monthStr = monthYear + '-';
  let filteredRecettes = recettes.filter(r => r.date.startsWith(monthStr));
  
  if (busMatricule !== 'all') {
    filteredRecettes = filteredRecettes.filter(r => r.matricule === busMatricule);
  }
  
  // Créer un objet pour stocker les recettes par jour
  const recettesByDay = {};
  filteredRecettes.forEach(r => {
    const day = r.date.split('-')[2];
    if (!recettesByDay[day]) {
      recettesByDay[day] = [];
    }
    recettesByDay[day].push(r);
  });
  
  // Générer le calendrier
  let calendarHTML = `
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="month-header">
          <h4 class="month-title">${firstDay.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h4>
        </div>
        <table class="calendar">
          <thead>
            <tr>
              <th>Dim</th>
              <th>Lun</th>
              <th>Mar</th>
              <th>Mer</th>
              <th>Jeu</th>
              <th>Ven</th>
              <th>Sam</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  let day = 1;
  let currentDate = new Date(year, month - 1, 1);
  
  for (let i = 0; i < 6; i++) { // 6 lignes max pour couvrir tous les mois
    if (day > daysInMonth) break;
    
    calendarHTML += '<tr>';
    
    for (let j = 0; j < 7; j++) { // 7 jours par semaine
      if ((i === 0 && j < firstDayOfWeek) || day > daysInMonth) {
        // Cellule vide avant le premier jour ou après le dernier jour du mois
        calendarHTML += '<td></td>';
      } else {
        const dayStr = String(day).padStart(2, '0');
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${dayStr}`;
        const today = new Date().toISOString().split('T')[0];
        
        // Déterminer le statut du jour
        let status = 'none';
        let tooltip = 'Pas de recette';
        
        if (recettesByDay[dayStr]) {
          const total = recettesByDay[dayStr].reduce((sum, r) => sum + r.montant, 0);
          if (total >= DAILY_TARGET) {
            status = 'complete';
            tooltip = `Recette complète: ${total.toLocaleString()} XAF`;
          } else {
            status = 'partial';
            tooltip = `Recette partielle: ${total.toLocaleString()} XAF`;
          }
        } else if (dateStr > today) {
          status = 'future';
          tooltip = 'Jour futur';
        }
        
        calendarHTML += `
          <td title="${tooltip}">
            <span class="calendar-day">${day}</span>
            <span class="day-badge badge-${status}">
              ${status === 'complete' ? '✓' : status === 'partial' ? '~' : status === 'future' ? '' : '✗'}
            </span>
          </td>
        `;
        day++;
      }
    }
    
    calendarHTML += '</tr>';
  }
  
  calendarHTML += `
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  calendarContainer.innerHTML = calendarHTML;
}

// Export des données
function exportToPDF(type) {
  showNotification('Export PDF en cours de développement', 'info');
}

function exportToExcel(type) {
  let data, fileName;
  
  if (type === 'recettes') {
    data = recettes.map(r => ({
      Date: formatDate(r.date),
      Matricule: r.matricule,
      Montant: r.montant,
      Commentaire: r.commentaire || '',
      'Date d\'enregistrement': formatDate(r.createdAt)
    }));
    fileName = `recettes_ml_transport_${new Date().toISOString().slice(0,10)}.xlsx`;
  } else {
    data = depenses.filter(d => !d.isSalary).map(d => ({
      Date: formatDate(d.date),
      Type: d.type === 'bus' ? 'Bus' : 'Entreprise',
      Bus: d.bus || 'N/A',
      Motif: d.motif,
      Montant: d.montant,
      Détails: d.details || '',
      Justificatif: d.justificatif || 'Non',
      'Date d\'enregistrement': formatDate(d.createdAt)
    }));
    fileName = `depenses_ml_transport_${new Date().toISOString().slice(0,10)}.xlsx`;
  }
  
  if (data.length === 0) {
    showNotification(`Aucune donnée à exporter pour les ${type}`, 'warning');
    return;
  }
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, type === 'recettes' ? "Recettes" : "Dépenses");
  XLSX.writeFile(wb, fileName);
}

function exportToCSV(type) {
  let data, fileName;
  
  if (type === 'recettes') {
    data = recettes.map(r => ({
      Date: formatDate(r.date),
      Matricule: r.matricule,
      Montant: r.montant,
      Commentaire: r.commentaire || '',
      'Date d\'enregistrement': formatDate(r.createdAt)
    }));
    fileName = `recettes_ml_transport_${new Date().toISOString().slice(0,10)}.csv`;
  } else {
    data = depenses.filter(d => !d.isSalary).map(d => ({
      Date: formatDate(d.date),
      Type: d.type === 'bus' ? 'Bus' : 'Entreprise',
      Bus: d.bus || 'N/A',
      Motif: d.motif,
      Montant: d.montant,
      Détails: d.details || '',
      Justificatif: d.justificatif || 'Non',
      'Date d\'enregistrement': formatDate(d.createdAt)
    }));
    fileName = `depenses_ml_transport_${new Date().toISOString().slice(0,10)}.csv`;
  }
  
  if (data.length === 0) {
    showNotification(`Aucune donnée à exporter pour les ${type}`, 'warning');
    return;
  }
  
  const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  saveAs(blob, fileName);
}

function exportSalariesToPDF() {
  showNotification('Export PDF des salaires en cours de développement', 'info');
}

function exportSalariesToExcel() {
  if (salaries.length === 0) {
    showNotification('Aucun salaire à exporter', 'warning');
    return;
  }
  
  const data = salaries.map(s => ({
    Date: formatDate(s.date),
    Chauffeur: s.driver,
    Mois: s.month,
    'Jours travaillés': s.workingDays,
    'Jours non travaillés': s.nonWorkingDays,
    Déduction: s.deduction,
    'Salaire payé': s.amount,
    'Salaire de base': BASE_SALARY,
    'Date d\'enregistrement': formatDate(s.createdAt)
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Salaires");
  XLSX.writeFile(wb, `salaires_ml_transport_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// Autres fonctions utilitaires
function afficherJustificatif(nomFichier) {
  // Dans une vraie application, vous récupéreriez l'image depuis un serveur
  // Ici nous affichons juste un message car nous n'avons pas de système de stockage
  showNotification(`Justificatif: ${nomFichier} (fonctionnalité complète à implémenter avec un backend)`, 'info');
}

function updateLastModified() {
  const lastModified = new Date(document.lastModified);
  document.getElementById('lastUpdate').textContent = lastModified.toLocaleDateString('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function filtrerDepenses(type) {
  currentFilter = type;
  afficherDepenses();
}

// Initialisation
function init() {
  // Remplir les sélecteurs
  populateBusSelect();
  populateBusFilter();
  populateDepenseBusSelect();
  populateEditBusSelect();
  populateEditDepenseBusSelect();
  populateCalendarBusSelect();
  populateDriverSelect();
  
  // Définir la date du jour par défaut
  const today = new Date();
  document.getElementById('dateRecette').valueAsDate = today;
  document.getElementById('dateDepense').valueAsDate = today;
  
  // Définir le mois actuel par défaut
  const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
  monthSelect.value = currentMonth;
  monthSalarySelect.value = currentMonth;
  
  // Afficher les données
  afficherRecettes();
  afficherDepenses();
  afficherHistoriqueSalaires();
  generateCalendar();
  mettreAJourTotaux();
  
  // Événements
  recetteForm.addEventListener('submit', handleRecetteSubmit);
  depenseForm.addEventListener('submit', handleDepenseSubmit);
  
  typeDepense.addEventListener('change', function() {
    busFieldDepense.classList.toggle('d-none', this.value !== 'bus');
  });
  
  document.getElementById('editDepenseType').addEventListener('change', function() {
    document.getElementById('editBusFieldDepense').classList.toggle('d-none', this.value !== 'bus');
  });
  
  document.getElementById('saveRecetteEdit').addEventListener('click', saveEditedRecette);
  document.getElementById('saveDepenseEdit').addEventListener('click', saveEditedDepense);
  
  searchRecette.addEventListener('input', function() {
    afficherRecettes(this.value);
  });
  
  filterBus.addEventListener('change', function() {
    afficherRecettes();
  });
  
  driverSelect.addEventListener('change', updateCalculateButtonState);
  monthSalarySelect.addEventListener('change', updateCalculateButtonState);
  calculateSalaryBtn.addEventListener('click', calculateSalary);
  paySalaryBtn.addEventListener('click', paySalary);
  searchSalary.addEventListener('input', function() {
    afficherHistoriqueSalaires(this.value);
  });
  
  updateLastModified();
}

// Démarrer l'application
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
